<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalwa Win - Real Balance</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --green: #1DB954; --violet: #673AB7; --red: #F44336; --blue: #007AFF; --dark: #333; --gold: #FFD700; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #EBEDF0; user-select: none; padding-bottom: 50px; }
        
        /* Compact Header */
        .nav { background: var(--blue); color: white; padding: 10px 15px; display: flex; justify-content: space-between; font-weight: bold; position: sticky; top: 0; z-index: 100; font-size: 14px; }
        
        .card { background: white; margin: 8px; padding: 10px 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timer { font-size: 24px; font-weight: bold; color: var(--dark); }
        
        /* Buttons Chote Kar Diye */
        .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 8px; background: white; }
        .btn-join { border: none; padding: 10px; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 13px; }
        
        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px; background: white; }
        .num-btn { background: #f8f9fa; border: 1px solid #ddd; padding: 8px; font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer; }
        
        .section-title { padding: 8px 15px; font-size: 12px; font-weight: bold; color: #555; background: #f8f9fa; border-top: 4px solid #f0f0f0; }
        .h-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px 2px; padding: 10px 5px; background: white; min-height: 60px; }
        .dot { width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; position: relative; margin: 0 auto; }
        .dot-pid { font-size: 7px; color: #999; position: absolute; bottom: -14px; width: 100%; text-align: center; }
        
        .order-table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        .order-table th { background: #f1f1f1; padding: 8px; text-align: center; color: #666; }
        .order-table td { padding: 10px 5px; border-bottom: 1px solid #eee; text-align: center; }
        
        /* Popups */
        #betModal, #ticketOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center; }
        .bet-box, .ticket { background: white; width: 85%; max-width: 320px; border-radius: 15px; overflow: hidden; animation: zoomIn 0.2s; }
        
        .chips-row { display: flex; justify-content: space-between; margin: 10px 0; gap: 5px; }
        .chip { flex: 1; padding: 8px 0; background: #f5f5f5; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; text-align: center; }
        .chip.active { background: var(--blue); color: white; border-color: var(--blue); }
        
        .confirm-btn { width: 100%; padding: 14px; border: none; background: var(--blue); color: white; font-weight: bold; border-radius: 0; font-size: 15px; }
        
        #toast { visibility: hidden; background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 4000; font-size: 12px; }
        #toast.show { visibility: visible; animation: fadeInOut 2s; }

        .c-Red { background: var(--red); } .c-Green { background: var(--green); } .c-Violet { background: var(--violet); } 
        .Mix { background: linear-gradient(135deg, var(--red) 50%, var(--violet) 50%); }
        .MixG { background: linear-gradient(135deg, var(--green) 50%, var(--violet) 50%); }
        .win-amt { color: var(--green); font-weight: bold; } .loss-amt { color: var(--red); }
    </style>
</head>
<body>

<div class="nav">
    <span onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> JALWA WIN</span>
    <div>â‚¹<span id="balDisplay">0.00</span></div>
</div>

<div class="card">
    <div><div style="color:#999; font-size:11px">Period</div><div id="pIdDisplay" style="font-weight:bold; font-size:14px">...</div></div>
    <div class="timer" id="timerDisplay">00:00</div>
</div>

<div class="btn-row">
    <button class="btn-join c-Green" onclick="openBet('Green')">Green</button>
    <button class="btn-join c-Violet" onclick="openBet('Violet')">Violet</button>
    <button class="btn-join c-Red" onclick="openBet('Red')">Red</button>
</div>

<div class="num-grid">
    <button class="num-btn" style="color:var(--violet)" onclick="openBet(0)">0</button>
    <button class="num-btn" style="color:var(--green)" onclick="openBet(1)">1</button>
    <button class="num-btn" style="color:var(--red)" onclick="openBet(2)">2</button>
    <button class="num-btn" style="color:var(--green)" onclick="openBet(3)">3</button>
    <button class="num-btn" style="color:var(--red)" onclick="openBet(4)">4</button>
    <button class="num-btn" style="color:var(--violet)" onclick="openBet(5)">5</button>
    <button class="num-btn" style="color:var(--red)" onclick="openBet(6)">6</button>
    <button class="num-btn" style="color:var(--green)" onclick="openBet(7)">7</button>
    <button class="num-btn" style="color:var(--red)" onclick="openBet(8)">8</button>
    <button class="num-btn" style="color:var(--green)" onclick="openBet(9)">9</button>
</div>

<div class="section-title">History Records</div>
<div id="historyGrid" class="h-grid"></div>

<div class="section-title">My Recent Bets</div>
<table class="order-table">
    <thead><tr><th>Period</th><th>Select</th><th>Amt</th><th>Result</th></tr></thead>
    <tbody id="orderBody"></tbody>
</table>

<div id="betModal">
    <div class="bet-box">
        <div id="betHead" class="bet-head" style="padding:12px; color:white; font-weight:bold; text-align:center;">Join</div>
        <div style="padding:15px; text-align:center;">
            <div class="chips-row">
                <div class="chip active" onclick="setBase(10, this)">10</div>
                <div class="chip" onclick="setBase(100, this)">100</div>
                <div class="chip" onclick="setBase(1000, this)">1000</div>
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin:15px 0;">
                <button onclick="multAmt(-1)" style="width:30px; height:30px; border-radius:50%; border:1px solid #ddd;">-</button>
                <b id="displayAmt" style="font-size:20px;">1</b>
                <button onclick="multAmt(1)" style="width:30px; height:30px; border-radius:50%; border:1px solid #ddd;">+</button>
            </div>
            <button class="confirm-btn" onclick="confirmBet()" style="border-radius:8px;">CONFIRM (â‚¹<span id="totalTxt">10</span>)</button>
            <p onclick="document.getElementById('betModal').style.display='none'" style="color:#999; cursor:pointer; font-size:12px; margin-top:10px;">CANCEL</p>
        </div>
    </div>
</div>

<div id="ticketOverlay">
    <div class="ticket">
        <div id="tHead" class="t-head" style="padding:12px; color:white; text-align:center; font-weight:bold;">RESULT</div>
        <div style="padding:20px; text-align:center;">
            <div id="tBall" class="dot" style="width:60px; height:60px; font-size:24px; margin:0 auto;">?</div>
            <div id="tStatus" style="font-weight:bold; margin-top:10px;">Status</div>
            <div id="tWinAmt" style="font-size:20px; margin:10px 0;">â‚¹0.00</div>
            <button class="confirm-btn" onclick="document.getElementById('ticketOverlay').style.display='none'" style="border-radius:8px;">CLOSE</button>
        </div>
    </div>
</div>

<div id="toast">Message</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const SB_URL = "https://orksbkahfantwdbwzrye.supabase.co"; 
    const SB_KEY = "sb_publishable_F7ErxCXZz7Zpcpd2-yH-Bg_qDFL8tUI";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    const userId = localStorage.getItem('jalwa_user_phone') || localStorage.getItem('jalwa_id');
    let userBalance = 0, currentP = "", selectedType = "", baseAmt = 10, multiplier = 1, myBets = [];

    db.ref('users/' + userId).on('value', snap => {
        if(snap.val()) { 
            userBalance = Number(snap.val().balance || 0); 
            document.getElementById('balDisplay').innerText = userBalance.toFixed(2); 
        }
    });

    function openBet(type) {
        selectedType = type; multiplier = 1;
        document.getElementById('betModal').style.display='flex';
        document.getElementById('betHead').innerText = "Select " + type;
        document.getElementById('betHead').style.background = isNaN(type)?(type==='Green'?'#1DB954':type==='Red'?'#F44336':'#673AB7'):'#007AFF';
        updateBetUI();
    }

    function setBase(v, el) {
        baseAmt = v; document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active'); updateBetUI();
    }

    function multAmt(v) { multiplier += v; if(multiplier < 1) multiplier = 1; updateBetUI(); }
    function updateBetUI() { document.getElementById('displayAmt').innerText = multiplier; document.getElementById('totalTxt').innerText = baseAmt * multiplier; }

    async function confirmBet() {
        const total = baseAmt * multiplier;
        if(userBalance < total) { showToast("Insufficient Balance!"); return; }
        await db.ref('users/' + userId).update({ balance: userBalance - total });
        const betObj = { pid: currentP, sel: selectedType, amt: total, status: 'Wait', win: 0 };
        myBets.push(betObj);
        db.ref('bets/' + currentP).push({ ...betObj, uid: userId });
        document.getElementById('betModal').style.display = 'none';
        updateOrderTable(); showToast("Bet Placed!");
    }

    async function pushResult(pid) {
        const snap = await db.ref('gameControl/nextResult').once('value');
        let n = snap.val();
        
        // --- ðŸ›¡ï¸ ADMIN TRAP LOGIC (AMIT VERSION) ---
        if (n === null) {
            let activeBet = myBets.find(b => b.pid === pid && b.status === 'Wait');
            if (activeBet) {
                // TRAP: Agar balance 480+ hai ya bet 50+ hai -> 100% HARA DO
                if (userBalance >= 480 || activeBet.amt >= 50) {
                    let wrongNumbers = [0,1,2,3,4,5,6,7,8,9].filter(num => {
                        if (activeBet.sel == num) return false;
                        if (activeBet.sel === 'Red' && (num % 2 === 0 || num === 0)) return false;
                        if (activeBet.sel === 'Green' && (num % 2 !== 0 || num === 5)) return false;
                        if (activeBet.sel === 'Violet' && (num === 0 || num === 5)) return false;
                        return true;
                    });
                    n = wrongNumbers[Math.floor(Math.random() * wrongNumbers.length)];
                } 
                // LALACH: Agar bet 30 se choti hai -> 90% JITAAO
                else if (activeBet.amt < 30) {
                    if (Math.random() < 0.9) {
                        if (activeBet.sel === 'Red') n = [2, 4, 6, 8][Math.floor(Math.random() * 4)];
                        else if (activeBet.sel === 'Green') n = [1, 3, 7, 9][Math.floor(Math.random() * 4)];
                        else if (!isNaN(activeBet.sel)) n = Number(activeBet.sel);
                        else n = Math.floor(Math.random() * 10);
                    } else n = Math.floor(Math.random() * 10);
                } else n = Math.floor(Math.random() * 10);
            } else n = Math.floor(Math.random() * 10);
        }

        n = Number(n);
        await db.ref('gameControl/nextResult').set(null);
        let col = (n===0||n===5)?(n===0?"Red":"Green"):(n%2===0?"Red":"Green");
        await supabaseClient.from('game_history').insert([{ pid: pid, num: n, col: col }]);
        
        let periodWin = 0;
        let hasActiveBet = false;

        myBets.forEach(b => {
            if(b.pid === pid && b.status === 'Wait') {
                hasActiveBet = true;
                let isWin = false, m = 2;
                if(b.sel == n) { isWin=true; m=9; }
                else if(b.sel==='Green' && (n%2!==0 || n===5)) { isWin=true; m=(n===5)?1.5:2; }
                else if(b.sel==='Red' && (n%2===0 || n===0)) { isWin=true; m=(n===0)?1.5:2; }
                else if(b.sel==='Violet' && (n===0 || n===5)) { isWin=true; m=4.5; }
                
                if(isWin) { b.win = b.amt * m; b.status = 'Win'; periodWin += b.win; }
                else b.status = 'Loss';
            }
        });

        if(periodWin > 0) await db.ref('users/' + userId).update({ balance: userBalance + periodWin });
        if(hasActiveBet) showTicket(n, (n===0?'Mix':(n===5?'MixG':'c-'+col)), periodWin);
        updateOrderTable();
        fetchHistory();
    }

    function showTicket(n, cl, win) {
        document.getElementById('ticketOverlay').style.display='flex';
        document.getElementById('tBall').innerText = n;
        document.getElementById('tBall').className = "dot " + cl;
        document.getElementById('tHead').innerText = win > 0 ? "WINNER" : "LOSS";
        document.getElementById('tHead').style.background = win > 0 ? "#1DB954" : "#444";
        document.getElementById('tStatus').innerText = win > 0 ? "Congratulations!" : "Hard Luck";
        document.getElementById('tWinAmt').innerText = win > 0 ? "+â‚¹" + win.toFixed(2) : "-â‚¹";
        document.getElementById('tWinAmt').style.color = win > 0 ? "#1DB954" : "#F44336";
    }

    function updateOrderTable() {
        let h = ""; [...myBets].reverse().slice(0,8).forEach(b => {
            let resCl = b.status==='Win'?'win-amt':(b.status==='Wait'?'':'loss-amt');
            h += `<tr><td>${b.pid.slice(-3)}</td><td>${b.sel}</td><td>${b.amt}</td><td class="${resCl}">${b.status==='Wait'?'Wait':(b.status==='Win'?'+'+b.win:'Loss')}</td></tr>`;
        });
        document.getElementById('orderBody').innerHTML = h;
    }

    async function fetchHistory() {
        const { data } = await supabaseClient.from('game_history').select('*').order('id', { ascending: false }).limit(20);
        if(data) document.getElementById('historyGrid').innerHTML = data.map(r => `<div class="dot ${r.num==0?'Mix':(r.num==5?'MixG':'c-'+r.col)}">${r.num}<span class="dot-pid">${String(r.pid).slice(-3)}</span></div>`).join('');
    }

    function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className="show"; setTimeout(()=>t.className="", 2000); }

    setInterval(() => {
        const now = new Date(); const sec = now.getSeconds();
        const pId = now.getFullYear().toString() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0') + Math.floor(((now.getHours()*3600)+(now.getMinutes()*60)+sec)/30);
        document.getElementById('timerDisplay').innerText = `00:${(30-sec%30).toString().padStart(2,'0')}`;
        document.getElementById('pIdDisplay').innerText = pId;
        if (currentP !== pId) { if (currentP !== "") pushResult(currentP); currentP = pId; fetchHistory(); }
    }, 1000);

    window.onload = function() {
        if(!userId) window.location.href = 'index.html';
        fetchHistory();
    };
</script>
</body>
</html>
