<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jalwa Pro - Wallet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --orange: #ff9800; --green: #22c55e; --red: #ef4444; --bg: #0d131f; --card: #1f293a; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; color: white; padding: 15px; }
        .back-btn { color: white; text-decoration: none; font-size: 18px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .balance-card { background: var(--card); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #2d3a4f; margin-bottom: 20px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 30px; }
        .btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-dep { background: #2196f3; color: white; }
        .btn-wit { background: #334155; color: white; }
        
        .recharge-box { background: white; color: #333; padding: 20px; border-radius: 15px; }
        .upi-copy { border: 2px dashed #2196f3; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; cursor: pointer; color: #2196f3; font-weight: bold; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .sub-btn { width: 100%; background: var(--green); color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; }

        /* Status Styles (Fixed) */
        .status-tag { padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; }
        .pending { background: #fef3c7; color: #92400e; }
        .approve { background: #dcfce7; color: #166534; }
        .rejected { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Wallet</a>

    <div class="balance-card">
        <div style="font-size: 14px; opacity: 0.7;">Total Balance</div>
        <div style="font-size: 36px; font-weight: bold; margin: 5px 0;">₹ <span id="balDisplay">0</span></div>
    </div>

    <div class="btn-group">
        <button class="btn btn-dep">Deposit</button>
        <button class="btn btn-wit">Withdraw</button>
    </div>

    <div class="recharge-box">
        <p style="margin: 0; font-weight: bold; font-size: 14px;">Add Cash</p>
        <div class="upi-copy" onclick="copyUPI()">
            <small style="color: #666; display: block;">Transfer to UPI ID</small>
            <span id="upiId">deepakdeepaksingh103@oksbi</span><br>
            <small style="font-size: 10px;">COPY UPI</small>
        </div>

        <input type="number" id="depAmount" placeholder="Amount (Min. ₹500)">
        <input type="text" id="depUTR" placeholder="12 Digit UTR / Transaction ID">
        <button class="sub-btn" onclick="submitDeposit()">Submit Deposit</button>
    </div>

    <div style="margin-top: 30px;">
        <p style="font-weight: bold;">Recent Deposits</p>
        <div id="rechargeHistory"></div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const userId = localStorage.getItem('jalwa_id');

        // Real-time Balance Update
        db.ref('users/' + userId).on('value', (snap) => {
            const data = snap.val();
            if(data) document.getElementById('balDisplay').innerText = (data.balance || 0).toFixed(2);
        });

        function copyUPI() {
            const upi = document.getElementById('upiId').innerText;
            navigator.clipboard.writeText(upi).then(() => alert("UPI ID Copied!"));
        }

        function submitDeposit() {
            const amt = document.getElementById('depAmount').value;
            const utr = document.getElementById('depUTR').value;

            if(!amt || amt < 500) return alert("Minimum deposit is ₹500");
            if(utr.length < 10) return alert("Enter valid UTR ID");

            db.ref('deposits').push({
                uid: userId,
                amount: Number(amt),
                utr: utr,
                status: 'pending',
                time: new Date().toLocaleString()
            }).then(() => {
                alert("Deposit Request Sent!");
                document.getElementById('depAmount').value = '';
                document.getElementById('depUTR').value = '';
            });
        }
    </script>
</body>
</html>

<div class="card">
    <div class="top-nav">
        <a href="index.html" class="back-link"><i class="fas fa-chevron-left"></i> Dashboard</a>
        <button class="close-btn" onclick="location.href='index.html'"><i class="fas fa-times"></i></button>
    </div>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="color: #64748b; font-size: 14px;">Total Balance</div>
        <div style="font-size: 28px; font-weight: bold; color: #1e293b;">₹<span id="headerBal">0</span></div>
    </div>

    <div class="tabs">
        <button class="tab active" id="tab-dep" onclick="showTab('deposit')">Deposit</button>
        <button class="tab" id="tab-wit" onclick="showTab('withdraw')">Withdraw</button>
    </div>

    <div id="depositSec">
        <h3 style="margin-top:0">Add Cash</h3>
        <div class="upi-box">
            <div style="font-size: 12px; color:var(--blue);">Transfer to UPI ID</div>
            <div style="font-size: 17px; font-weight: bold; margin: 5px 0;" id="adminUpi">deepakdeepaksingh103@oksbi</div>
            <button onclick="copyUPI()" style="background:none; border:none; color:var(--blue); cursor:pointer; font-weight:bold;">COPY UPI</button>
        </div>
        <div class="input-group">
            <label>Amount (Min. ₹500)</label>
            <input type="number" id="depAmount" placeholder="Enter amount">
        </div>
        <div class="input-group">
            <label>UTR / Transaction ID</label>
            <input type="text" id="utrNumber" placeholder="12 Digit UTR Number">
        </div>
        <button class="btn-action btn-deposit" onclick="submitDeposit()">Submit Deposit</button>
    </div>

    <div id="withdrawSec" style="display:none;">
        <h3 style="margin-top:0">Withdraw Cash</h3>
        <div class="input-group">
            <label>Withdraw Amount</label>
            <input type="number" id="witAmount" placeholder="Min. ₹500">
        </div>
        <div class="input-group">
            <label>Full Name (Bank/UPI)</label>
            <input type="text" id="witName" placeholder="Enter name">
        </div>
        <div class="input-group">
            <label>UPI ID</label>
            <input type="text" id="witUpi" placeholder="example@ybl">
        </div>
        <button class="btn-action btn-withdraw" id="witBtn" onclick="submitWithdraw()">Request Withdrawal</button>
    </div>

    <div class="history-sec">
        <h4 id="histTitle" style="margin-bottom: 10px; color: #1e293b;">Recent Deposits</h4>
        <div id="histList"></div>
    </div>
</div>

<script>
    // Config
    const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Auth Check: Agar login nahi hai toh login.html par bhejo
    const userId = localStorage.getItem('jalwa_id');
    if(!userId) {
        window.location.href = "login.html"; 
    }

    // Live Balance Sync
    db.ref('users/' + userId + '/balance').on('value', snap => {
        document.getElementById('headerBal').innerText = snap.val() || 0;
    });

    function showTab(type) {
        document.getElementById('tab-dep').classList.toggle('active', type === 'deposit');
        document.getElementById('tab-wit').classList.toggle('active', type === 'withdraw');
        document.getElementById('depositSec').style.display = type === 'deposit' ? 'block' : 'none';
        document.getElementById('withdrawSec').style.display = type === 'withdraw' ? 'block' : 'none';
        document.getElementById('histTitle').innerText = type === 'deposit' ? 'Recent Deposits' : 'Recent Withdrawals';
        loadHistory(type);
    }

    function loadHistory(type) {
        const path = type === 'deposit' ? 'requests/deposits' : 'requests/withdrawals';
        db.ref(path).orderByChild('uid').equalTo(userId).limitToLast(10).on('value', snap => {
            let html = "";
            let items = [];
            snap.forEach(child => { items.push(child.val()); });
            items.reverse().forEach(data => {
                let status = data.status || 'pending';
                let label = status === 'pending' ? 'Panding' : (status === 'success' ? 'Approve' : 'Rejected');
                html += `<div class="hist-item"><div><div style="font-weight:bold; font-size:14px;">₹${data.amount}</div><div style="font-size:10px; color:#64748b;">${new Date(data.time).toLocaleString()}</div></div><div class="status-badge ${label.toLowerCase()}">${label}</div></div>`;
            });
            document.getElementById('histList').innerHTML = html || '<p style="text-align:center; color:#94a3b8; font-size:12px;">No history.</p>';
        });
    }

    function copyUPI() {
        navigator.clipboard.writeText(document.getElementById('adminUpi').innerText);
        alert("UPI Copied!");
    }

    function submitDeposit() {
        const amt = parseFloat(document.getElementById('depAmount').value);
        const utr = document.getElementById('utrNumber').value;
        if(amt < 500 || utr.length < 10) return alert("Min ₹500 & valid UTR required");
        db.ref('requests/deposits').push({ uid: userId, amount: amt, utr: utr, status: 'pending', time: Date.now() }).then(() => {
            alert("Deposit Request Sent!");
            document.getElementById('depAmount').value = "";
            document.getElementById('utrNumber').value = "";
        });
    }

    function submitWithdraw() {
        const amt = parseFloat(document.getElementById('witAmount').value);
        const name = document.getElementById('witName').value;
        const upi = document.getElementById('witUpi').value;
        const btn = document.getElementById('witBtn');
        if(amt < 500 || !name || !upi) return alert("Please fill all details (Min ₹500)");
        btn.disabled = true;
        btn.innerText = "Processing...";
        const balRef = db.ref('users/' + userId + '/balance');
        balRef.transaction((currentBalance) => {
            if (currentBalance < amt) return; 
            return currentBalance - amt;
        }, (error, committed) => {
            if (committed) {
                db.ref('requests/withdrawals').push({ uid: userId, amount: amt, details: { name: name, upi: upi, method: 'UPI' }, status: 'pending', time: Date.now() }).then(() => {
                    alert("Withdrawal Requested! Balance deducted.");
                    btn.disabled = false; btn.innerText = "Request Withdrawal";
                    document.getElementById('witAmount').value = "";
                });
            } else {
                alert("Insufficient Balance!");
                btn.disabled = false; btn.innerText = "Request Withdrawal";
            }
        });
    }
    loadHistory('deposit');
</script>
</body>
</html>

<div class="card">
    <div class="top-nav">
        <a href="index.html" class="back-link"><i class="fas fa-chevron-left"></i> Home</a>
        <button class="close-btn" onclick="location.href='index.html'"><i class="fas fa-times"></i></button>
    </div>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="color: #64748b; font-size: 14px;">Total Balance</div>
        <div style="font-size: 28px; font-weight: bold; color: #1e293b;">₹<span id="headerBal">0</span></div>
    </div>

    <div class="tabs">
        <button class="tab active" id="tab-dep" onclick="showTab('deposit')">Deposit</button>
        <button class="tab" id="tab-wit" onclick="showTab('withdraw')">Withdraw</button>
    </div>

    <div id="depositSec">
        <h3 style="margin-top:0">Add Cash</h3>
        <div class="upi-box">
            <div style="font-size: 12px; color:var(--blue);">Transfer to UPI ID</div>
            <div style="font-size: 17px; font-weight: bold; margin: 5px 0;" id="adminUpi">deepakdeepaksingh103@oksbi</div>
            <button onclick="copyUPI()" style="background:none; border:none; color:var(--blue); cursor:pointer; font-weight:bold;">COPY UPI</button>
        </div>
        <div class="input-group">
            <label>Amount (Min. ₹500)</label>
            <input type="number" id="depAmount" placeholder="Enter amount">
        </div>
        <div class="input-group">
            <label>UTR / Transaction ID</label>
            <input type="text" id="utrNumber" placeholder="12 Digit UTR Number">
        </div>
        <button class="btn-action btn-deposit" onclick="submitDeposit()">Submit Deposit</button>
    </div>

    <div id="withdrawSec" style="display:none;">
        <h3 style="margin-top:0">Withdraw Cash</h3>
        <div class="input-group">
            <label>Withdraw Amount</label>
            <input type="number" id="witAmount" placeholder="Min. ₹500">
        </div>
        <div class="input-group">
            <label>Full Name (Bank/UPI)</label>
            <input type="text" id="witName" placeholder="Enter name">
        </div>
        <div class="input-group">
            <label>UPI ID</label>
            <input type="text" id="witUpi" placeholder="example@ybl">
        </div>
        <button class="btn-action btn-withdraw" id="witBtn" onclick="submitWithdraw()">Request Withdrawal</button>
    </div>

    <div class="history-sec">
        <h4 id="histTitle" style="margin-bottom: 10px; color: #1e293b;">Recent Deposits</h4>
        <div id="histList"></div>
    </div>
</div>

<script>
    // Config
    const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Auth Check: Agar login nahi hai toh login.html par bhejo
    const userId = localStorage.getItem('jalwa_id');
    if(!userId) {
        window.location.href = "login.html"; 
    }

    // Live Balance Sync
    db.ref('users/' + userId + '/balance').on('value', snap => {
        document.getElementById('headerBal').innerText = snap.val() || 0;
    });

    function showTab(type) {
        document.getElementById('tab-dep').classList.toggle('active', type === 'deposit');
        document.getElementById('tab-wit').classList.toggle('active', type === 'withdraw');
        document.getElementById('depositSec').style.display = type === 'deposit' ? 'block' : 'none';
        document.getElementById('withdrawSec').style.display = type === 'withdraw' ? 'block' : 'none';
        document.getElementById('histTitle').innerText = type === 'deposit' ? 'Recent Deposits' : 'Recent Withdrawals';
        loadHistory(type);
    }

    function loadHistory(type) {
        const path = type === 'deposit' ? 'requests/deposits' : 'requests/withdrawals';
        db.ref(path).orderByChild('uid').equalTo(userId).limitToLast(10).on('value', snap => {
            let html = "";
            let items = [];
            snap.forEach(child => { items.push(child.val()); });
            items.reverse().forEach(data => {
                let status = data.status || 'pending';
                let label = status === 'pending' ? 'Panding' : (status === 'success' ? 'Approve' : 'Rejected');
                html += `<div class="hist-item"><div><div style="font-weight:bold; font-size:14px;">₹${data.amount}</div><div style="font-size:10px; color:#64748b;">${new Date(data.time).toLocaleString()}</div></div><div class="status-badge ${label.toLowerCase()}">${label}</div></div>`;
            });
            document.getElementById('histList').innerHTML = html || '<p style="text-align:center; color:#94a3b8; font-size:12px;">No history.</p>';
        });
    }

    function copyUPI() {
        navigator.clipboard.writeText(document.getElementById('adminUpi').innerText);
        alert("UPI Copied!");
    }

    function submitDeposit() {
        const amt = parseFloat(document.getElementById('depAmount').value);
        const utr = document.getElementById('utrNumber').value;
        if(amt < 500 || utr.length < 10) return alert("Min ₹500 & valid UTR required");
        db.ref('requests/deposits').push({ uid: userId, amount: amt, utr: utr, status: 'pending', time: Date.now() }).then(() => {
            alert("Deposit Request Sent!");
            document.getElementById('depAmount').value = "";
            document.getElementById('utrNumber').value = "";
        });
    }

    function submitWithdraw() {
        const amt = parseFloat(document.getElementById('witAmount').value);
        const name = document.getElementById('witName').value;
        const upi = document.getElementById('witUpi').value;
        const btn = document.getElementById('witBtn');
        if(amt < 500 || !name || !upi) return alert("Please fill all details (Min ₹500)");
        btn.disabled = true;
        btn.innerText = "Processing...";
        const balRef = db.ref('users/' + userId + '/balance');
        balRef.transaction((currentBalance) => {
            if (currentBalance < amt) return; 
            return currentBalance - amt;
        }, (error, committed) => {
            if (committed) {
                db.ref('requests/withdrawals').push({ uid: userId, amount: amt, details: { name: name, upi: upi, method: 'UPI' }, status: 'pending', time: Date.now() }).then(() => {
                    alert("Withdrawal Requested! Balance deducted.");
                    btn.disabled = false; btn.innerText = "Request Withdrawal";
                    document.getElementById('witAmount').value = "";
                });
            } else {
                alert("Insufficient Balance!");
                btn.disabled = false; btn.innerText = "Request Withdrawal";
            }
        });
    }
    loadHistory('deposit');
</script>
</body>
</html>
        .panding { background: #fef3c7; color: var(--orange); }
        .approve { background: #dcfce7; color: var(--green); }
        .rejected { background: #fee2e2; color: var(--red); }
    </style>
</head>
<body>

<div class="card">
    <div class="top-nav">
        <a href="index.html" class="back-link"><i class="fas fa-chevron-left"></i> index.html</a>
        <button class="close-btn" onclick="location.href='dashboard.html'"><i class="fas fa-times"></i></button>
    </div>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="color: #64748b; font-size: 14px;">Total Balance</div>
        <div style="font-size: 28px; font-weight: bold; color: #1e293b;">₹<span id="headerBal">0</span></div>
    </div>

    <div class="tabs">
        <button class="tab active" id="tab-dep" onclick="showTab('deposit')">Deposit</button>
        <button class="tab" id="tab-wit" onclick="showTab('withdraw')">Withdraw</button>
    </div>

    <div id="depositSec">
        <h3 style="margin-top:0">Add Cash</h3>
        <div class="upi-box">
            <div style="font-size: 12px; color:var(--blue);">Transfer to UPI ID</div>
            <div style="font-size: 17px; font-weight: bold; margin: 5px 0;" id="adminUpi">deepakdeepaksingh103@oksbi</div>
            <button onclick="copyUPI()" style="background:none; border:none; color:var(--blue); cursor:pointer; font-weight:bold;">COPY UPI</button>
        </div>
        <div class="input-group">
            <label>Amount (Min. ₹500)</label>
            <input type="number" id="depAmount" placeholder="Enter amount">
        </div>
        <div class="input-group">
            <label>UTR / Transaction ID</label>
            <input type="text" id="utrNumber" placeholder="12 Digit UTR Number">
        </div>
        <button class="btn-action btn-deposit" onclick="submitDeposit()">Submit Deposit</button>
    </div>

    <div id="withdrawSec" style="display:none;">
        <h3 style="margin-top:0">Withdraw Cash</h3>
        <div class="input-group">
            <label>Withdraw Amount</label>
            <input type="number" id="witAmount" placeholder="Min. ₹500">
        </div>
        <div class="input-group">
            <label>Full Name (Bank/UPI)</label>
            <input type="text" id="witName" placeholder="Enter name">
        </div>
        <div class="input-group">
            <label>UPI ID</label>
            <input type="text" id="witUpi" placeholder="example@ybl">
        </div>
        <button class="btn-action btn-withdraw" id="witBtn" onclick="submitWithdraw()">Request Withdrawal</button>
    </div>

    <div class="history-sec">
        <h4 id="histTitle" style="margin-bottom: 10px; color: #1e293b;">Recent Deposits</h4>
        <div id="histList"></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // User ID fetching from localStorage
    const userId = localStorage.getItem('jalwa_id');

    // 1. Live Balance Sync
    db.ref('users/' + userId + '/balance').on('value', snap => {
        document.getElementById('headerBal').innerText = snap.val() || 0;
    });

    function showTab(type) {
        document.getElementById('tab-dep').classList.toggle('active', type === 'deposit');
        document.getElementById('tab-wit').classList.toggle('active', type === 'withdraw');
        document.getElementById('depositSec').style.display = type === 'deposit' ? 'block' : 'none';
        document.getElementById('withdrawSec').style.display = type === 'withdraw' ? 'block' : 'none';
        document.getElementById('histTitle').innerText = type === 'deposit' ? 'Recent Deposits' : 'Recent Withdrawals';
        loadHistory(type);
    }

    function loadHistory(type) {
        const path = type === 'deposit' ? 'requests/deposits' : 'requests/withdrawals';
        db.ref(path).orderByChild('uid').equalTo(userId).limitToLast(10).on('value', snap => {
            let html = "";
            let items = [];
            snap.forEach(child => { items.push(child.val()); });
            items.reverse().forEach(data => {
                let status = data.status || 'pending';
                let label = status === 'pending' ? 'Panding' : (status === 'success' ? 'Approve' : 'Rejected');
                html += `
                    <div class="hist-item">
                        <div>
                            <div style="font-weight:bold; font-size:14px;">₹${data.amount}</div>
                            <div style="font-size:10px; color:#64748b;">${new Date(data.time).toLocaleString()}</div>
                        </div>
                        <div class="status-badge ${label.toLowerCase()}">${label}</div>
                    </div>`;
            });
            document.getElementById('histList').innerHTML = html || '<p style="text-align:center; color:#94a3b8; font-size:12px;">No history.</p>';
        });
    }

    function copyUPI() {
        navigator.clipboard.writeText(document.getElementById('adminUpi').innerText);
        alert("UPI Copied!");
    }

    function submitDeposit() {
        const amt = parseFloat(document.getElementById('depAmount').value);
        const utr = document.getElementById('utrNumber').value;
        if(amt < 500 || utr.length < 10) return alert("Min ₹500 & valid UTR required");
        
        db.ref('requests/deposits').push({
            uid: userId, amount: amt, utr: utr, status: 'pending', time: Date.now()
        }).then(() => {
            alert("Deposit Request Sent!");
            document.getElementById('depAmount').value = "";
            document.getElementById('utrNumber').value = "";
        });
    }

    // FIX: Balance deduction on Withdrawal Request
    function submitWithdraw() {
        const amt = parseFloat(document.getElementById('witAmount').value);
        const name = document.getElementById('witName').value;
        const upi = document.getElementById('witUpi').value;
        const btn = document.getElementById('witBtn');

        if(amt < 500 || !name || !upi) return alert("Please fill all details (Min ₹500)");

        btn.disabled = true;
        btn.innerText = "Processing...";

        const balRef = db.ref('users/' + userId + '/balance');

        balRef.transaction((currentBalance) => {
            if (currentBalance === null) return 0;
            if (currentBalance < amt) {
                return; // Insufficient balance: transaction aborts
            }
            return currentBalance - amt;
        }, (error, committed, snapshot) => {
            if (error) {
                alert("Transaction Failed!");
                btn.disabled = false;
                btn.innerText = "Request Withdrawal";
            } else if (!committed) {
                alert("Insufficient Balance!");
                btn.disabled = false;
                btn.innerText = "Request Withdrawal";
            } else {
                // Balance deducted, now save request
                db.ref('requests/withdrawals').push({
                    uid: userId,
                    amount: amt,
                    details: { name: name, upi: upi, method: 'UPI' },
                    status: 'pending',
                    time: Date.now()
                }).then(() => {
                    alert("Withdrawal Requested! Amount deducted from wallet.");
                    btn.disabled = false;
                    btn.innerText = "Request Withdrawal";
                    document.getElementById('witAmount').value = "";
                });
            }
        });
    }

    loadHistory('deposit');
</script>
</body>
</html>
