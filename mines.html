<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalwa Mines Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #00e701; --bg-dark: #1a2c38; --bg-card: #0f212e; --tile: #2f4553; --tile-hover: #557086; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-dark); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Header */
        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-card); border-radius: 10px; margin-bottom: 15px; border: 1px solid #213743; }
        .balance-box { background: #071824; padding: 8px 15px; border-radius: 20px; color: var(--primary); font-weight: bold; border: 1px solid #2f4553; }

        /* Grid System */
        .game-container { background: var(--bg-card); padding: 15px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .tile { aspect-ratio: 1; background: var(--tile); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.15s; position: relative; font-size: 24px; box-shadow: 0 4px 0 #213743; }
        .tile:active { transform: translateY(2px); box-shadow: none; }
        .tile.open { background: #071824; box-shadow: none; transform: translateY(2px); cursor: default; }
        .tile.diamond { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .tile.bomb { color: #ff4d4d; text-shadow: 0 0 10px #ff4d4d; }

        /* Controls */
        .controls { width: 100%; text-align: left; }
        .label-sm { font-size: 12px; color: #8899a6; margin-left: 5px; }
        .input-box { background: #2f4553; border: 2px solid #3c5261; border-radius: 8px; display: flex; align-items: center; padding: 5px 10px; margin: 5px 0 15px 0; }
        .input-box input, .input-box select { background: transparent; border: none; color: white; width: 100%; padding: 10px; outline: none; font-weight: bold; font-size: 16px; }
        
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-bet { background: var(--primary); color: #000; box-shadow: 0 4px 0 #009d01; }
        .btn-cashout { background: #ff9800; color: #000; display: none; box-shadow: 0 4px 0 #b36b00; }

        #status-msg { text-align: center; margin-bottom: 10px; font-weight: bold; min-height: 24px; }
        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
        .pop { animation: pop 0.2s ease-out; }
    </style>
</head>
<body>

<div class="header">
    <div onclick="window.history.back()" style="cursor:pointer"><i class="fas fa-arrow-left"></i></div>
    <div style="font-weight: 900; letter-spacing: 1px;">MINES</div>
    <div class="balance-box">₹ <span id="balance">0.00</span></div>
</div>

<div class="game-container">
    <div id="status-msg" style="color: var(--primary);">Multiplier: 1.00x</div>
    <div class="grid" id="mineGrid"></div>

    <div class="controls">
        <span class="label-sm">Bet Amount</span>
        <div class="input-box">
            <i class="fas fa-coins" style="color: #ff9800;"></i>
            <input type="number" id="betAmt" value="10" min="1">
        </div>

        <span class="label-sm">Mines</span>
        <div class="input-box">
            <i class="fas fa-bomb" style="color: #ff4d4d;"></i>
            <select id="mineCount">
                <option value="1">1 Mine</option><option value="3" selected>3 Mines</option>
                <option value="5">5 Mines</option><option value="10">10 Mines</option>
                <option value="20">20 Mines</option>
            </select>
        </div>

        <button id="btnBet" class="btn btn-bet" onclick="startGame()">Place Bet</button>
        <button id="btnCashout" class="btn btn-cashout" onclick="cashout()">Cashout</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Auto-fetch User ID from Dashboard login
    const userId = localStorage.getItem('jalwa_user_phone') || localStorage.getItem('jalwa_id');

    let wallet = 0, betAmount = 0, mines = [], gameActive = false, openedTiles = 0;
    let profitLimit = 350; // Default limit (Admin panel overrides this)

    // SYNC BALANCE & ADMIN SETTINGS
    if(userId) {
        db.ref('users/' + userId).on('value', snap => {
            wallet = snap.val()?.balance || 0;
            document.getElementById('balance').innerText = wallet.toFixed(2);
        });
    }

    db.ref('gameSettings/mines').on('value', snap => {
        if(snap.val()) profitLimit = snap.val().limit;
    });

    function createGrid() {
        const grid = document.getElementById('mineGrid');
        grid.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.onclick = () => reveal(i, tile);
            grid.appendChild(tile);
        }
    }

    function startGame() {
        if(!userId) return alert("Please login first!");
        betAmount = parseFloat(document.getElementById('betAmt').value);
        if (wallet < betAmount) return; // No alert to keep it smooth
        if (betAmount < 1) return;

        // Update Balance
        db.ref('users/' + userId).update({ balance: wallet - betAmount });
        
        // Update Live Status for Admin Panel
        db.ref('liveStatus/' + userId).set({ game: 'Mines', bet: betAmount });

        gameActive = true;
        openedTiles = 0;
        mines = generateMines();
        
        document.getElementById('btnBet').style.display = 'none';
        document.getElementById('btnCashout').style.display = 'block';
        document.getElementById('status-msg').style.color = 'var(--primary)';
        document.getElementById('status-msg').innerText = "Multiplier: 1.00x";
        createGrid();
    }

    function generateMines() {
        let m = [];
        let count = parseInt(document.getElementById('mineCount').value);
        while(m.length < count) {
            let r = Math.floor(Math.random() * 25);
            if(!m.includes(r)) m.push(r);
        }
        return m;
    }

    function reveal(idx, el) {
        if (!gameActive || el.classList.contains('open')) return;

        // SMART MANIPULATION: Admin profit limit check
        let forceBomb = (wallet > profitLimit && openedTiles >= 2);

        if (mines.includes(idx) || forceBomb) {
            el.innerHTML = '<i class="fas fa-bomb"></i>';
            el.classList.add('open', 'bomb', 'pop');
            gameOver(false);
        } else {
            el.innerHTML = '<i class="fas fa-gem"></i>';
            el.classList.add('open', 'diamond', 'pop');
            openedTiles++;
            updateMultiplier();
        }
    }

    function updateMultiplier() {
        let mCount = parseInt(document.getElementById('mineCount').value);
        let mult = (24.5 / (25 - mCount - openedTiles)).toFixed(2);
        document.getElementById('status-msg').innerText = "Multiplier: " + mult + "x";
        document.getElementById('btnCashout').innerText = "Cashout ₹" + (betAmount * mult).toFixed(2);
    }

    function cashout() {
        let multText = document.getElementById('status-msg').innerText;
        let mult = parseFloat(multText.split(' ')[1]);
        let win = betAmount * mult;
        
        db.ref('users/' + userId).update({ balance: wallet + win });
        db.ref('liveStatus/' + userId).remove();
        gameOver(true);
    }

    function gameOver(win) {
        gameActive = false;
        document.getElementById('btnBet').style.display = 'block';
        document.getElementById('btnCashout').style.display = 'none';
        
        if(!win) {
            document.getElementById('status-msg').style.color = '#ff4d4d';
            document.getElementById('status-msg').innerText = "BOMB EXPLODED!";
            db.ref('liveStatus/' + userId).remove();
        }

        const tiles = document.querySelectorAll('.tile');
        mines.forEach(m => {
            if(!tiles[m].classList.contains('open')) {
                tiles[m].innerHTML = '<i class="fas fa-bomb" style="opacity:0.4"></i>';
                tiles[m].classList.add('open');
            }
        });
    }

    createGrid();
</script>
</body>
</html>
