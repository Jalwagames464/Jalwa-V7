<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalwa Win - Pro Dark</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --green: #1DB954; --violet: #9c27b0; --red: #ff4757; 
            --blue: #007AFF; --bg-dark: #0a0e1a; --card-bg: #161d2b;
            --text-dim: #a4b0be;
        }
        body { 
            margin: 0; font-family: 'Poppins', sans-serif; 
            background: var(--bg-dark); color: white; user-select: none; padding-bottom: 20px; 
        }

        /* Nav Style */
        .nav { 
            background: #161d2b; color: #00ffca; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #1f2855;
        }
        .bal-display { background: rgba(0,255,202,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid #00ffca; color: #00ffca; }

        /* Timer Card */
        .card { 
            background: var(--card-bg); margin: 15px; padding: 20px; border-radius: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: relative; border: 1px solid #1f2855;
        }
        .p-label { color: var(--text-dim); font-size: 11px; text-transform: uppercase; }
        .p-id { font-weight: bold; font-size: 18px; color: #00ffca; margin-top: 5px; }
        .timer { font-size: 32px; font-weight: 800; color: white; font-family: 'Courier New', monospace; }

        #lockOverlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(10,14,26,0.9); z-index: 2000; justify-content: center; 
            align-items: center; border-radius: 15px; font-weight: bold; color: var(--red); 
            font-size: 14px; letter-spacing: 2px; 
        }

        /* Color Buttons */
        .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 10px 15px; }
        .btn-join { 
            border: none; padding: 15px; color: white; font-weight: bold; border-radius: 12px; 
            cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 13px;
        }
        .btn-join:active { transform: scale(0.9); }

        /* Number Balls Logic */
        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 15px; }
        .num-btn { 
            width: 50px; height: 50px; background: #1f2855; border: none; font-size: 18px; 
            font-weight: bold; border-radius: 50%; cursor: pointer; transition: 0.3s;
            color: white; display: flex; align-items: center; justify-content: center; margin: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .num-btn:active { transform: scale(0.8); }

        .section-title { padding: 20px 15px 10px; font-size: 12px; font-weight: bold; color: var(--text-dim); }
        .h-grid { 
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 18px 2px; 
            padding: 20px 10px 30px; background: var(--card-bg); margin: 0 15px; border-radius: 15px;
        }
        .dot { 
            width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; color: white; font-weight: bold; font-size: 11px; 
            position: relative; margin: 0 auto; 
        }
        .dot-pid { font-size: 8px; color: #555; position: absolute; bottom: -16px; }

        .order-table { width: 100%; border-collapse: collapse; background: var(--card-bg); font-size: 13px; border-radius: 15px; overflow: hidden; margin-top: 5px; color: white; }
        .order-table td { padding: 15px 5px; border-bottom: 1px solid #1f2855; text-align: center; }

        /* Popups */
        #ticketOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; 
            align-items: center; backdrop-filter: blur(8px); 
        }
        .ticket { background: #161d2b; width: 85%; max-width: 320px; border-radius: 30px; text-align: center; border: 2px solid #1f2855; }
        .ticket-head { padding: 20px; font-weight: 900; font-size: 22px; letter-spacing: 1px; }
        .res-ball { width: 80px; height: 80px; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 35px; font-weight: 900; }

        /* Bet Modal */
        #betModal { display: none; position: fixed; bottom: 0; width: 100%; background: #161d2b; z-index: 3000; border-radius: 30px 30px 0 0; padding: 30px; box-sizing: border-box;}
        .chip { padding: 10px 25px; background: #0a0e1a; border-radius: 10px; cursor: pointer; border: 1px solid #1f2855; color: white; }
        .chip.active { background: var(--blue); border-color: var(--blue); }

        .c-Red { background: var(--red); } .c-Green { background: var(--green); } .c-Violet { background: var(--violet); } 
        .Mix { background: linear-gradient(135deg, var(--red) 50%, var(--violet) 50%); }
        .MixG { background: linear-gradient(135deg, var(--green) 50%, var(--violet) 50%); }
        .win-amt { color: var(--green); font-weight: bold; } .loss-amt { color: var(--red); }
    </style>
</head>
<body>

<div class="nav"><span>JALWA WIN PRO</span><div class="bal-display">â‚¹<span id="balDisplay">0.00</span></div></div>

<div class="card">
    <div><div class="p-label">Period</div><div id="pIdDisplay" class="p-id">...</div></div>
    <div class="timer" id="timerDisplay">00:00</div>
    <div id="lockOverlay"><i class="fas fa-hourglass-half"></i> CALCULATION...</div>
</div>

<div class="btn-row">
    <button class="btn-join c-Green" onclick="openBet('Green')">Green</button>
    <button class="btn-join c-Violet" onclick="openBet('Violet')">Violet</button>
    <button class="btn-join c-Red" onclick="openBet('Red')">Red</button>
</div>

<div class="num-grid">
    <button class="num-btn" style="border: 2px solid var(--violet);" onclick="openBet(0)">0</button>
    <button class="num-btn" style="border: 2px solid var(--green);" onclick="openBet(1)">1</button>
    <button class="num-btn" style="border: 2px solid var(--red);" onclick="openBet(2)">2</button>
    <button class="num-btn" style="border: 2px solid var(--green);" onclick="openBet(3)">3</button>
    <button class="num-btn" style="border: 2px solid var(--red);" onclick="openBet(4)">4</button>
    <button class="num-btn" style="border: 2px solid var(--violet);" onclick="openBet(5)">5</button>
    <button class="num-btn" style="border: 2px solid var(--red);" onclick="openBet(6)">6</button>
    <button class="num-btn" style="border: 2px solid var(--green);" onclick="openBet(7)">7</button>
    <button class="num-btn" style="border: 2px solid var(--red);" onclick="openBet(8)">8</button>
    <button class="num-btn" style="border: 2px solid var(--green);" onclick="openBet(9)">9</button>
</div>

<div class="section-title"><span><i class="fas fa-history"></i> HISTORY RECORDS</span></div>
<div id="historyGrid" class="h-grid"></div>

<div class="section-title"><span><i class="fas fa-list"></i> MY BETS</span></div>
<div style="padding: 0 15px;"><table class="order-table"><tbody id="orderBody"></tbody></table></div>

<div id="betModal">
    <div id="betHead" style="padding:10px; color:white; font-weight:bold; text-align:center;">Join</div>
    <div style="text-align:center;">
        <div style="display:flex; justify-content:space-around; margin: 20px 0;"><div class="chip active" onclick="setBase(10, this)">10</div><div class="chip" onclick="setBase(100, this)">100</div><div class="chip" onclick="setBase(1000, this)">1000</div></div>
        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:20px;">
            <button onclick="changeMult(-1)" style="width:40px; height:40px; border-radius:50%; border:1px solid #333; background:#000; color:#fff;">-</button>
            <b id="multDisplay" style="font-size:20px;">1</b>
            <button onclick="changeMult(1)" style="width:40px; height:40px; border-radius:50%; border:1px solid #333; background:#000; color:#fff;">+</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-join" onclick="document.getElementById('betModal').style.display='none'" style="background:#333; flex:1;">CANCEL</button>
            <button class="btn-join" onclick="confirmBet()" style="background:var(--blue); flex:2;">CONFIRM â‚¹<span id="totalTxt">10</span></button>
        </div>
    </div>
</div>

<div id="ticketOverlay">
    <div class="ticket">
        <div id="tHead" class="ticket-head">RESULT</div>
        <div style="padding:20px 20px 40px;">
            <div id="tBall" class="res-ball">?</div>
            <h2 id="tWinAmt" style="margin:10px 0; font-size:40px;">â‚¹0.00</h2>
            <p id="tStatusText" style="color:var(--text-dim); font-weight:bold;"></p>
            <button class="btn-join" onclick="document.getElementById('ticketOverlay').style.display='none'" style="background:white; color:black; width:100%; border-radius: 50px; margin-top:20px;">CLOSE</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwav7-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const SB_URL = "https://orksbkahfantwdbwzrye.supabase.co", SB_KEY = "sb_publishable_F7ErxCXZz7Zpcpd2-yH-Bg_qDFL8tUI";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    const userId = localStorage.getItem('jalwa_user_phone') || 'Guest';
    let myBets = JSON.parse(localStorage.getItem('my_jalwa_bets') || "[]");
    let userBalance = 0, currentP = "", selectedType = "", baseAmt = 10, multiplier = 1, isLocked = false, lastProcessedPid = "";
    let userBetOnCurrentPeriod = null;

    db.ref('users/' + userId).on('value', snap => {
        if(snap.val()) { 
            const d = snap.val();
            userBalance = Number(d.balance || 0); 
            document.getElementById('balDisplay').innerText = userBalance.toFixed(2); 
        }
    });

    // --- ðŸš¨ KILLER ENGINE LOGIC ---
    async function getKillerDecision(currentBetAmt) {
        // 1. Admin Fix Check
        const adminSnap = await db.ref('gameControl/manualResult').once('value');
        if (adminSnap.exists() && adminSnap.val() !== "none") return "admin";

        const userSnap = await db.ref('users/' + userId).once('value');
        const d = userSnap.val() || {};
        
        let bal = d.balance || 0;
        let deposit = d.totalDeposit || 0;

        // Rule: Bonus user (daily 20rs) limit 400
        if (deposit < 100 && bal > 380) return "force_loss";

        // Rule: Recharge user (500rs) limit 600
        if (deposit >= 500 && deposit < 1000 && bal > 580) return "force_loss";

        // Rule: High Bet Killer (40rs se badi bet = 100% loss)
        if (currentBetAmt >= 40) return "force_loss";

        return "normal";
    }

    function openBet(t) { if(isLocked) return; selectedType = t; multiplier = 1; document.getElementById('betModal').style.display='block'; document.getElementById('betHead').innerText = "Join " + t; document.getElementById('betHead').style.background = isNaN(t)?(t==='Green'?'#1DB954':t==='Red'?'#F44336':'#673AB7'):'#007AFF'; updateBetUI(); }
    function setBase(v, el) { baseAmt = v; document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); updateBetUI(); }
    function changeMult(v) { multiplier += v; if(multiplier < 1) multiplier = 1; updateBetUI(); }
    function updateBetUI() { document.getElementById('multDisplay').innerText = multiplier; document.getElementById('totalTxt').innerText = (baseAmt * multiplier); }

    async function confirmBet() {
        const total = baseAmt * multiplier;
        if(userBalance < total) { alert("Insufficient Balance"); return; }
        await db.ref('users/' + userId).update({ balance: userBalance - total });
        userBetOnCurrentPeriod = { sel: selectedType, amt: total };
        const b = { pid: currentP, sel: selectedType, amt: total, status: 'Wait', win: 0 };
        myBets.push(b); localStorage.setItem('my_jalwa_bets', JSON.stringify(myBets));
        db.ref('bets/' + currentP).push({ ...b, uid: userId });
        document.getElementById('betModal').style.display = 'none';
        updateOrderTable();
    }

    async function processResult(pid) {
        if(!pid || lastProcessedPid === pid) return;
        lastProcessedPid = pid;

        // Check Decision
        let betAmt = userBetOnCurrentPeriod ? userBetOnCurrentPeriod.amt : 0;
        let decision = await getKillerDecision(betAmt);

        let n, col;
        
        if (decision === "force_loss" && userBetOnCurrentPeriod) {
            // Forcefully choose a losing number
            let sel = userBetOnCurrentPeriod.sel;
            if (sel === "Green") n = 2; // Red
            else if (sel === "Red") n = 1; // Green
            else if (sel === "Violet") n = 1; // Green
            else n = (userBetOnCurrentPeriod.sel == 1) ? 2 : 1; // Opposite number
        } else {
            // Normal Random
            n = Math.floor(Math.random() * 10);
        }

        col = (n===0||n===5)?(n===0?"Red":"Green"):(n%2===0?"Red":"Green");
        
        // Save to History
        await supabaseClient.from('game_history').insert([{ pid: pid, num: n, col: col }]);
        
        settle(pid, n, col);
        userBetOnCurrentPeriod = null; // Reset for next round
        setTimeout(fetchHistory, 500);
    }

    function settle(pid, n, col) {
        let winSum = 0, found = false;
        myBets.forEach(b => {
            if(b.pid === pid && b.status === 'Wait') {
                found = true; let isW = false, m = 1.9;
                if(b.sel == n) { isW=true; m=9; }
                else if(b.sel==='Green' && (n%2!==0 || n===5)) { isW=true; m=(n===5)?1.5:1.9; }
                else if(b.sel==='Red' && (n%2===0 || n===0)) { isW=true; m=(n===0)?1.5:1.9; }
                else if(b.sel==='Violet' && (n===0 || n===5)) { isW=true; m=4.5; }
                if(isW) { b.win = b.amt * m; b.status = 'Win'; winSum += b.win; } else b.status = 'Loss';
            }
        });
        if(found) {
            localStorage.setItem('my_jalwa_bets', JSON.stringify(myBets));
            if(winSum > 0) db.ref('users/' + userId).update({ balance: userBalance + winSum });
            showTicket(n, (n===0?'Mix':(n===5?'MixG':'c-'+col)), winSum);
            updateOrderTable();
        }
    }

    function showTicket(n, cl, win) {
        document.getElementById('ticketOverlay').style.display='flex';
        document.getElementById('tBall').innerText = n;
        document.getElementById('tBall').className = "res-ball " + cl;
        document.getElementById('tHead').innerText = win > 0 ? "WINNER!" : "LOST";
        document.getElementById('tHead').style.color = win > 0 ? "#1DB954" : "#ff4757";
        document.getElementById('tWinAmt').innerText = win > 0 ? "+â‚¹" + win.toFixed(1) : "â‚¹0.00";
        document.getElementById('tWinAmt').style.color = win > 0 ? "#1DB954" : "#ff4757";
        document.getElementById('tStatusText').innerText = win > 0 ? "Congratulations! Reward Added." : "Oops! Better luck next time.";
    }

    function updateOrderTable() {
        let h = ""; [...myBets].reverse().slice(0,10).forEach(b => {
            h += `<tr><td>${String(b.pid).slice(-3)}</td><td style="font-weight:bold">${b.sel}</td><td>â‚¹${b.amt}</td><td class="${b.status==='Win'?'win-amt':'loss-amt'}">${b.status==='Wait'?'Wait':(b.status==='Win'?'+'+b.win:'Loss')}</td></tr>`;
        });
        document.getElementById('orderBody').innerHTML = h || "<tr><td colspan='4' style='padding:20px; color:gray;'>No data</td></tr>";
    }

    async function fetchHistory() {
        const { data } = await supabaseClient.from('game_history').select('*').order('id', { ascending: false }).limit(20);
        if(data) document.getElementById('historyGrid').innerHTML = data.map(r => `<div class="dot ${r.num==0?'Mix':(r.num==5?'MixG':'c-'+r.col)}">${r.num}<span class="dot-pid">${String(r.pid).slice(-3)}</span></div>`).join('');
    }

    function sync() {
        const now = new Date();
        const sec = now.getSeconds();
        const rem = 30 - (sec % 30);
        isLocked = rem <= 3;
        document.getElementById('lockOverlay').style.display = isLocked ? 'flex' : 'none';
        const pId = generateCurrentPid();
        document.getElementById('timerDisplay').innerText = `00:${rem.toString().padStart(2, '0')}`;
        document.getElementById('pIdDisplay').innerText = pId;
        if (currentP !== pId) { let last = currentP; currentP = pId; if(last) processResult(last); }
    }

    function generateCurrentPid() {
        const now = new Date();
        return now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + Math.floor(((now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds()) / 30);
    }

    setInterval(sync, 1000);
    setInterval(fetchHistory, 5000); 
    window.onload = () => { updateOrderTable(); sync(); };
</script>
</body>
</html>
